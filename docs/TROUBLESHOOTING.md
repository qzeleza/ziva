# Решение проблем

Частые проблемы и способы их устранения при работе с Termos на разных платформах и в разных терминалах. Все рекомендации соответствуют текущему состоянию кода.

## Отрисовка и разметка

- Недостаточная ширина или «ломающиеся» строки
  - Причина: слишком маленькое значение `width` для `View(width)`/`FinalView(width)`.
  - Решение: вычисляйте ширину через `common.CalculateLayoutWidth(screenWidth)` или используйте `common.DefaultWidth`.
  - Примечание: `YesNoTask.View` принудительно использует минимум `common.DefaultWidth`; прочие задачи рендерят строки как есть — передавайте разумную ширину.

- Неправильное выравнивание правых меток или обрезание текста
  - Причина: отступы посчитаны без учета ANSI; широкие Unicode‑символы.
  - Решение: используйте `ui.AlignTextToRight(left, right, width)`, который учитывает ANSI через `ui.GetPlainTextLength`.
  - Если строите строки вручную — применяйте `ui.GetPlainTextLength` для измерений.

- «Мусор» при перенаправлении вывода в файл/лог
  - Причина: в тексте остаются ANSI‑коды.
  - Решение: перед логированием удалите ANSI с помощью `ui.StripANSI(text)`.

## Клавиши не работают

- Стрелки не двигают курсор
  - Попробуйте Vim‑клавиши: up/k и down/j работают во всех списках; left/h и right/l переключают Yes/No.
  - Убедитесь, что терминал пропускает нажатия (нет конфликтов в tmux/привязках).

- Space/Enter не подтверждают
  - `SingleSelectTask`: enter/space — подтвердить.
  - `MultiSelectTask`: space — переключить, enter — подтвердить.
  - `YesNoTask`: enter/space — подтвердить текущий выбор.

- Отмена
  - `YesNoTask`: q/esc/ctrl+c — установить ошибку и завершить.

## Ввод и валидация

- Ввод никогда не завершается
  - Причина: `InputTaskNew` завершается по Enter; валидатор может возвращать ошибку.
  - Решение: передайте `validator func(string) error`, который возвращает nil для корректного ввода, либо передайте `nil`, чтобы отключить валидацию.

- Backspace работает «рваными» шагами
  - `InputTaskNew` удаляет последний рун по байтам; сложные составные символы могут удаляться в несколько шагов в некоторых терминалах.

## Интеграция с Bubble Tea

- Ничего не отображается / мгновенный выход
  - Убедитесь, что ваша модель Bubble Tea возвращает текущую задачу из `Update` и выходит только когда `task.IsDone()` стало true.
  - `Run()` у встроенных задач возвращает `nil`; инициализировать программу командой из `Init()` безопасно (верните `task.Run()`).

- Мерцание или чрезмерные перерисовки
  - Перерисовывайте только при изменениях состояния из `Update`.
  - Не пересоздавайте стили lipgloss в каждом кадре; переиспользуйте экспортируемые стили из `ui` и изменяйте их один раз при инициализации.

## Ширина Unicode/Emoji/CJK

- Смещения при широких символах
  - Используйте `ui.WrapText(text, width)` и `ui.GetRuneWidth(r)` для корректного рендера.
  - На очень узких терминалах предпочтительнее ASCII.

## Совместимость Windows и терминалов

- Старый cmd.exe показывает «кракозябры»
  - Используйте Windows Terminal или любой терминал с поддержкой ANSI/ConPTY.

- В SSH‑сессиях игнорируются некоторые клавиши
  - Проверьте TERM и настройки проброса клавиш в клиенте SSH.

## Производительность на embedded‑целях

- Много аллокаций при сборке строк
  - Используйте пулы: `performance.GetBuffer()` / `performance.PutBuffer()`.
  - Склеивайте строки через `performance.FastConcat`, `JoinEfficient`, `RepeatEfficient`.

- Большой объём вывода «тормозит» UI
  - Ограничивайте ширину через `common.CalculateLayoutWidth`; избегайте огромных многострочных блоков за кадр.

## Отображение ошибок

- Ошибки выходят за пределы экрана
  - Применяйте `ui.FormatErrorMessage(text, width)` для переноса и отступов.

- Невозможно отличить статус от сообщения
  - Настройте цвета ошибок через `ui.SetErrorColor(messageColor, statusColor)` или верните значения по умолчанию через `ui.ResetErrorColors()`.

## Проблемы со сборкой/модулем

- Не работает `go get`
  - Проверьте путь модуля: `github.com/qzeleza/termos`.
  - Требуется Go 1.22+.

- Пример не запускается
  - Выполните: `go run ./examples/basic_usage.go` из корня репозитория.

## Известные ограничения

- `Run()` во встроенных задачах синхронный (возвращает `nil`). Фоновую работу нужно реализовывать отдельно в вашей Bubble Tea‑модели.
- `InputTaskNew` обрабатывает нажатия по байтам; составной ввод может отличаться в зависимости от терминала.

Если проблема сохраняется, откройте issue с указанием типа терминала, ОС, версии Go и минимального примера воспроизведения.
